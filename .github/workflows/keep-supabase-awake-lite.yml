name: Keep Supabase Awake (Lite)

on:
  schedule:
    # Run every 30 minutes - fits within free tier limits
    # 48 runs/day × 30 days × 1 minute = ~1,440 minutes/month
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Supabase Project
        run: |
          echo "🔍 Starting Supabase health check..."
          echo "Timestamp: $(date)"
          
          # Check if secrets are available
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "❌ SUPABASE_URL secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "❌ SUPABASE_ANON_KEY secret is not set"
            exit 1
          fi
          
          echo "✅ Secrets are configured"
          
          # Simple ping to keep Supabase awake with better error handling
          echo "🚀 Pinging Supabase..."
          if curl -f -s "${{ secrets.SUPABASE_URL }}/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 3; then
            echo "✅ Pinged Supabase successfully at $(date)"
          else
            echo "❌ Supabase ping failed - but continuing to avoid breaking the workflow"
            echo "Exit code: $?"
          fi

      - name: Health Check Log
        run: |
          echo "🏥 Health check completed at $(date)"
          echo "🚀 Workflow finished - keeping your project alive!" 