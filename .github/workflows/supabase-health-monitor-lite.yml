name: Supabase Health Monitor (Lite)

on:
  schedule:
    # Run every 2 hours during active hours (8 AM - 10 PM UTC)
    # 7 runs/day Ã— 30 days Ã— 2 minutes = ~420 minutes/month
    - cron: '0 8-22/2 * * *'
    # Run every 4 hours during off hours (10 PM, 2 AM, 6 AM UTC)  
    # 3 runs/day Ã— 30 days Ã— 2 minutes = ~180 minutes/month
    - cron: '0 22,2,6 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  MAX_RETRIES: 2
  RETRY_DELAY: 3

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Supabase Database Health Check
        id: db-check
        run: |
          echo "ğŸ” Checking Supabase database health..."
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s "${{ secrets.SUPABASE_URL }}/rest/v1/" \
              -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
              -w "HTTP Status: %{http_code}, Response Time: %{time_total}s\n" > /tmp/db_response 2>&1; then
              echo "âœ… Database ping successful on attempt $i"
              cat /tmp/db_response
              echo "db_status=success" >> $GITHUB_OUTPUT
              break
            else
              echo "âŒ Database ping failed on attempt $i"
              if [ $i -eq $MAX_RETRIES ]; then
                echo "db_status=failed" >> $GITHUB_OUTPUT
              else
                echo "â³ Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done

      - name: Supabase Auth Health Check
        id: auth-check
        run: |
          echo "ğŸ” Checking Supabase auth health..."
          
          if curl -f -s "${{ secrets.SUPABASE_URL }}/auth/v1/health" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -w "HTTP Status: %{http_code}, Response Time: %{time_total}s\n" > /tmp/auth_response 2>&1; then
            echo "âœ… Auth service healthy"
            cat /tmp/auth_response
            echo "auth_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Auth service check failed"
            echo "auth_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Health Summary
        run: |
          echo "ğŸ“Š HEALTH CHECK SUMMARY"
          echo "======================="
          echo "ğŸ• Timestamp: $(date -u)"
          echo "ğŸ—„ï¸  Database: ${{ steps.db-check.outputs.db_status }}"
          echo "ğŸ” Auth: ${{ steps.auth-check.outputs.auth_status }}"
          echo "======================="
          
          if [[ "${{ steps.db-check.outputs.db_status }}" == "success" ]]; then
            echo "ğŸ‰ Supabase project is healthy and awake!"
          else
            echo "âš ï¸ Some health checks failed"
          fi

      - name: Create Issue on Failure
        if: ${{ steps.db-check.outputs.db_status == 'failed' && github.event_name == 'schedule' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const title = `ğŸš¨ Supabase Health Check Failed - ${new Date().toISOString()}`;
            const body = `
            ## Health Check Failure Report
            
            **Time**: ${new Date().toUTCString()}
            **Database Status**: ${{ steps.db-check.outputs.db_status }}
            **Auth Status**: ${{ steps.auth-check.outputs.auth_status }}
            
            The automated health check detected issues with the Supabase project.
            Please investigate and resolve the issues.
            
            **Workflow Run**: ${context.payload.repository.html_url}/actions/runs/${context.runId}
            `;
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: ['supabase-health', 'automated']
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ['supabase-health', 'automated', 'bug']
              });
            } 