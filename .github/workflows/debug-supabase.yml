name: Debug Supabase Secrets

on:
  workflow_dispatch: # Manual trigger only

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Secret Configuration
        run: |
          echo "🔍 Debugging Supabase configuration..."
          
          # Check if secrets exist (without revealing values)
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "❌ SUPABASE_URL secret is empty or not set"
          else
            echo "✅ SUPABASE_URL secret is set"
            echo "URL length: ${#SUPABASE_URL}"
            # Show first few chars to verify format
            echo "URL starts with: ${SUPABASE_URL:0:8}..."
          fi
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "❌ SUPABASE_ANON_KEY secret is empty or not set"
          else
            echo "✅ SUPABASE_ANON_KEY secret is set"
            echo "Key length: ${#SUPABASE_ANON_KEY}"
            # Show first few chars to verify format
            echo "Key starts with: ${SUPABASE_ANON_KEY:0:8}..."
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Test Basic Curl
        run: |
          echo "🧪 Testing basic curl commands..."
          
          # Test basic connectivity first
          echo "Testing basic HTTPS connectivity..."
          if curl -f -s "https://httpbin.org/status/200"; then
            echo "✅ Basic HTTPS works"
          else
            echo "❌ Basic HTTPS failed"
          fi
          
          # Test Supabase URL format
          echo "Testing Supabase URL accessibility..."
          if curl -f -s "${{ secrets.SUPABASE_URL }}" --max-time 10; then
            echo "✅ Supabase URL is accessible"
          else
            echo "❌ Supabase URL is not accessible"
            echo "Exit code: $?"
          fi

      - name: Test Supabase REST Endpoint
        run: |
          echo "🔗 Testing Supabase REST API..."
          
          # More detailed curl with error output
          if curl -f -s -v "${{ secrets.SUPABASE_URL }}/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            --max-time 15 2>&1; then
            echo "✅ Supabase REST API accessible"
          else
            echo "❌ Supabase REST API failed"
            echo "Exit code: $?"
            echo "Trying without auth headers..."
            curl -f -s -v "${{ secrets.SUPABASE_URL }}/rest/v1/" --max-time 10 2>&1 || true
          fi

      - name: Test Auth Endpoint
        run: |
          echo "🔐 Testing Supabase Auth endpoint..."
          
          if curl -f -s "${{ secrets.SUPABASE_URL }}/auth/v1/health" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            --max-time 10 2>&1; then
            echo "✅ Supabase Auth endpoint accessible"
          else
            echo "❌ Supabase Auth endpoint failed"
            echo "Exit code: $?"
          fi 